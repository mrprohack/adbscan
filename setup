#!/bin/bash

# Enhanced setup script for adbscan - cross-Linux distribution support
# Exit on any error
set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Check if running as root
if [[ $EUID -eq 0 ]]; then
    print_error "Please do not run this script as root. Use sudo when prompted if needed."
    exit 1
fi

# Detect Linux distribution
detect_distro() {
    if [[ -f /etc/os-release ]]; then
        . /etc/os-release
        DISTRO=$ID
        VERSION=$VERSION_ID
    elif [[ -f /etc/redhat-release ]]; then
        DISTRO="rhel"
    elif [[ -f /etc/debian_version ]]; then
        DISTRO="debian"
    else
        DISTRO="unknown"
    fi
    echo "$DISTRO"
}

# Check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Install packages based on distro
install_packages() {
    local distro=$1
    local packages=("$@")
    packages=("${packages[@]:1}") # Remove distro from array

    case $distro in
        ubuntu|debian|linuxmint|pop)
            print_status "Detected Debian-based system. Using apt..."
            sudo apt update
            sudo apt install -y "${packages[@]}"
            ;;
        fedora|rhel|centos)
            print_status "Detected Red Hat-based system. Using dnf..."
            sudo dnf install -y "${packages[@]}"
            ;;
        arch|manjaro)
            print_status "Detected Arch-based system. Using pacman..."
            sudo pacman -Sy --noconfirm "${packages[@]}"
            ;;
        opensuse*|sles)
            print_status "Detected SUSE-based system. Using zypper..."
            sudo zypper refresh
            sudo zypper install -y "${packages[@]}"
            ;;
        *)
            print_error "Unsupported distribution: $distro"
            print_warning "Please install the following packages manually:"
            printf '%s\n' "${packages[@]}"
            exit 1
            ;;
    esac
}

# Main installation logic
main() {
    print_status "Starting adbscan setup..."

    DISTRO=$(detect_distro)
    print_status "Detected distribution: $DISTRO"

    # Define packages based on distro
    declare -a packages

    case $DISTRO in
        ubuntu|debian|linuxmint|pop)
            packages=(libpcap0.8 libpcap0.8-dev libpcap-dev parallel masscan nmap nload android-tools python3-pip)
            ;;
        fedora|rhel|centos)
            packages=(libpcap libpcap-devel parallel masscan nmap nload android-tools python3-pip)
            ;;
        arch|manjaro)
            packages=(libpcap parallel masscan nmap nload android-tools python-pip)
            ;;
        opensuse*|sles)
            packages=(libpcap libpcap-devel parallel masscan nmap nload android-tools python3-pip)
            ;;
        *)
            print_error "Unsupported distribution. Please check the README for manual installation."
            exit 1
            ;;
    esac

    # Check if packages are already installed
    local missing_packages=()
    for pkg in "${packages[@]}"; do
        if ! command_exists "$pkg" 2>/dev/null; then
            # For some packages, check specific commands
            case $pkg in
                android-tools|android-tools-adb)
                    if ! command_exists adb; then
                        missing_packages+=("$pkg")
                    fi
                    ;;
                python3-pip|python-pip)
                    if ! command_exists pip3 && ! command_exists pip; then
                        missing_packages+=("$pkg")
                    fi
                    ;;
                masscan)
                    if ! command_exists masscan; then
                        missing_packages+=("$pkg")
                    fi
                    ;;
                *)
                    missing_packages+=("$pkg")
                    ;;
            esac
        fi
    done

    if [[ ${#missing_packages[@]} -eq 0 ]]; then
        print_status "All system packages are already installed."
    else
        print_status "Installing missing packages: ${missing_packages[*]}"
        install_packages "$DISTRO" "${missing_packages[@]}"
    fi

    # Install Python shodan library
    print_status "Installing Python shodan library..."
    if command_exists pip3; then
        pip3 install --user shodan
    elif command_exists pip; then
        pip install --user shodan
    else
        print_error "pip not found. Please install pip first."
        exit 1
    fi

    print_status "Setup completed successfully!"
    print_status "You can now run adbscan. See README.md for usage instructions."
}

# Run main function
main "$@"
